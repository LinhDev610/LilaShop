# PROMPT CHI TIáº¾T: XÃ‚Y Dá»°NG Há»† THá»NG CHATBOT AI CHO WEBSITE Má»¸ PHáº¨M

## ğŸ“‹ Tá»”NG QUAN Há»† THá»NG

XÃ¢y dá»±ng má»™t há»‡ thá»‘ng Chatbot AI tÆ° váº¥n sáº£n pháº©m má»¹ pháº©m vá»›i cÃ¡c Ä‘áº·c Ä‘iá»ƒm sau:

### CÃ´ng Nghá»‡ Sá»­ Dá»¥ng
- **Backend**: Spring Boot (Java) hoáº·c Node.js/Python
- **Frontend**: ReactJS hoáº·c framework tÆ°Æ¡ng Ä‘Æ°Æ¡ng
- **AI Service**: Google Gemini API (hoáº·c OpenAI GPT, Claude)
- **Database**: MySQL/PostgreSQL
- **Cache**: In-memory cache hoáº·c Redis

### Má»¥c TiÃªu
- TÆ° váº¥n sáº£n pháº©m má»¹ pháº©m dá»±a trÃªn database thá»±c táº¿
- Duy trÃ¬ context conversation qua sessionId
- Há»— trá»£ filter sáº£n pháº©m theo danh má»¥c, thÆ°Æ¡ng hiá»‡u, loáº¡i da
- Tá»‘i Æ°u performance vá»›i caching mechanism

---

## ğŸ—ï¸ KIáº¾N TRÃšC Há»† THá»NG

### 1. Luá»“ng Dá»¯ Liá»‡u (Data Flow)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User gá»­i cÃ¢u há»i qua Frontend                                  â”‚
â”‚  "Báº¡n cÃ³ sáº£n pháº©m nÃ o cho da dáº§u khÃ´ng?"                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ChatbotController.ask()                                        â”‚
â”‚  POST /api/chatbot/ask                                          â”‚
â”‚  Body: { message: "...", sessionId: "..." }                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ChatbotService.ask()                                           â”‚
â”‚  - Kiá»ƒm tra cache sáº£n pháº©m                                      â”‚
â”‚  - Náº¿u cache háº¿t háº¡n â†’ refreshProductsContext()                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ProductService.getActiveProducts()                             â”‚
â”‚  - Query database láº¥y sáº£n pháº©m cÃ³ status = APPROVED            â”‚
â”‚  - Ãp dá»¥ng promotion (náº¿u cÃ³)                                   â”‚
â”‚  - Convert Entity â†’ DTO                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Format thÃ nh Text Context                                      â”‚
â”‚  "DANH SÃCH Sáº¢N PHáº¨M:                                          â”‚
â”‚   1. TÃªn: Kem dÆ°á»¡ng áº©m | GiÃ¡: 250,000 VNÄ | Loáº¡i da: Da dáº§u"  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ÄÆ°a vÃ o Prompt cho Gemini AI                                   â”‚
â”‚  systemPrompt + productsContext + userMessage                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gá»i Gemini API                                                 â”‚
â”‚  POST https://generativelanguage.googleapis.com/...             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gemini AI phÃ¢n tÃ­ch vÃ  tráº£ lá»i                                â”‚
â”‚  "ChÃºng tÃ´i cÃ³ sáº£n pháº©m Kem dÆ°á»¡ng áº©m cho da dáº§u..."            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LÆ°u vÃ o Conversation History (sessionId)                       â”‚
â”‚  Tráº£ vá» Frontend                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¾ Cáº¤U TRÃšC DATABASE

### Báº£ng Sáº£n Pháº©m (Products)

```sql
CREATE TABLE products (
    id VARCHAR(36) PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(10, 2) NOT NULL,
    brand VARCHAR(100),
    status VARCHAR(50) NOT NULL, -- 'APPROVED', 'PENDING', 'REJECTED'
    category_id VARCHAR(36),
    skin_type VARCHAR(100), -- 'Da dáº§u', 'Da khÃ´', 'Da há»—n há»£p', etc.
    texture VARCHAR(100), -- 'Kem', 'Gel', 'NÆ°á»›c', etc.
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (category_id) REFERENCES categories(id)
);
```

### Báº£ng Danh Má»¥c (Categories)

```sql
CREATE TABLE categories (
    id VARCHAR(36) PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    parent_id VARCHAR(36) NULL, -- Danh má»¥c cha
    status BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (parent_id) REFERENCES categories(id)
);
```

### Dá»¯ Liá»‡u Máº«u

```sql
-- Danh má»¥c cha
INSERT INTO categories (id, name, parent_id, status) VALUES
('cat-001', 'Trang Ä‘iá»ƒm', NULL, TRUE),
('cat-002', 'ChÄƒm sÃ³c da', NULL, TRUE),
('cat-003', 'NÆ°á»›c hoa', NULL, TRUE);

-- Danh má»¥c con
INSERT INTO categories (id, name, parent_id, status) VALUES
('cat-101', 'Trang Ä‘iá»ƒm mÃ´i', 'cat-001', TRUE),
('cat-102', 'Trang Ä‘iá»ƒm máº¯t', 'cat-001', TRUE),
('cat-201', 'Kem dÆ°á»¡ng', 'cat-002', TRUE),
('cat-202', 'Sá»¯a rá»­a máº·t', 'cat-002', TRUE);

-- Sáº£n pháº©m
INSERT INTO products (id, name, description, price, brand, status, category_id, skin_type, texture) VALUES
('prod-001', 'Kem dÆ°á»¡ng áº©m cho da dáº§u', 'Kem dÆ°á»¡ng áº©m khÃ´ng gÃ¢y bÃ³ng nhá»n', 250000, 'La Roche-Posay', 'APPROVED', 'cat-201', 'Da dáº§u', 'Gel'),
('prod-002', 'Son Dior Addict Lip Glow', 'Son dÆ°á»¡ng mÃ´i mÃ u tá»± nhiÃªn', 850000, 'Dior', 'APPROVED', 'cat-101', 'Má»i loáº¡i da', 'SÃ¡p'),
('prod-003', 'NÆ°á»›c hoa Chanel No.5', 'NÆ°á»›c hoa ná»¯ cá»• Ä‘iá»ƒn', 3500000, 'Chanel', 'APPROVED', 'cat-003', NULL, 'NÆ°á»›c');
```

---

## ğŸ”§ IMPLEMENTATION CHI TIáº¾T

### PHáº¦N 1: BACKEND SERVICE

#### 1.1. ChatbotController (API Endpoint)

**Spring Boot (Java):**

```java
@RestController
@RequestMapping("/api/chatbot")
@RequiredArgsConstructor
@Slf4j
public class ChatbotController {
    
    private final ChatbotService chatbotService;
    
    @PostMapping("/ask")
    public ApiResponse<ChatResponse> ask(@Valid @RequestBody ChatRequest request) {
        log.info("Chatbot request received: {}", request.getMessage());
        ChatResponse response = chatbotService.ask(request);
        return ApiResponse.<ChatResponse>builder()
                .result(response)
                .build();
    }
}
```

**Node.js (Express):**

```javascript
const express = require('express');
const router = express.Router();
const chatbotService = require('../services/chatbotService');

router.post('/ask', async (req, res) => {
    try {
        const { message, sessionId } = req.body;
        console.log('Chatbot request received:', message);
        
        const response = await chatbotService.ask(message, sessionId);
        
        res.json({
            code: 1000,
            result: response
        });
    } catch (error) {
        console.error('Chatbot error:', error);
        res.status(500).json({
            code: 5000,
            message: 'Internal server error'
        });
    }
});

module.exports = router;
```

**Python (Flask):**

```python
from flask import Blueprint, request, jsonify
from services.chatbot_service import ChatbotService
import logging

chatbot_bp = Blueprint('chatbot', __name__)
chatbot_service = ChatbotService()

@chatbot_bp.route('/ask', methods=['POST'])
def ask():
    try:
        data = request.get_json()
        message = data.get('message')
        session_id = data.get('sessionId')
        
        logging.info(f'Chatbot request received: {message}')
        
        response = chatbot_service.ask(message, session_id)
        
        return jsonify({
            'code': 1000,
            'result': response
        })
    except Exception as e:
        logging.error(f'Chatbot error: {str(e)}')
        return jsonify({
            'code': 5000,
            'message': 'Internal server error'
        }), 500
```

---

#### 1.2. ChatbotService (Core Logic)

**CÃ¡c Chá»©c NÄƒng ChÃ­nh:**

1. **Cache Mechanism**: Cache sáº£n pháº©m trong 30 phÃºt
2. **Conversation History**: LÆ°u lá»‹ch sá»­ chat theo sessionId
3. **Smart Context**: Chá»‰ Ä‘Æ°a context cáº§n thiáº¿t vÃ o prompt
4. **Error Handling**: Xá»­ lÃ½ retry cho quota exceeded

**Spring Boot (Java) - Core Methods:**

```java
@Service
@Slf4j
public class ChatbotService {
    
    // Constants
    private static final String GEMINI_API_BASE_URL = "https://generativelanguage.googleapis.com/v1beta";
    private static final long PRODUCTS_CACHE_TTL = 30 * 60 * 1000; // 30 phÃºt
    
    // Dependencies
    private final WebClient webClient;
    private final ProductService productService;
    private final CategoryService categoryService;
    private final String apiKey;
    private final String model;
    
    // Cache
    private String cachedProductsContext = "";
    private long lastProductsCacheUpdate = 0;
    
    // Conversation history (cÃ³ thá»ƒ dÃ¹ng Redis cho production)
    private final Map<String, List<GeminiContent>> conversationHistory = new HashMap<>();
    
    // System Prompt - QUAN TRá»ŒNG NHáº¤T
    private static final String SYSTEM_PROMPT_BASE = """
        Báº¡n lÃ  trá»£ lÃ½ AI chuyÃªn nghiá»‡p cá»§a website Nova Beauty - má»™t cá»­a hÃ ng má»¹ pháº©m vÃ  chÄƒm sÃ³c sáº¯c Ä‘áº¹p uy tÃ­n.
        
        VAI TRÃ’: Há»— trá»£ khÃ¡ch hÃ ng nhiá»‡t tÃ¬nh, chuyÃªn nghiá»‡p, thÃ¢n thiá»‡n. TÆ° váº¥n sáº£n pháº©m, giáº£i Ä‘Ã¡p tháº¯c máº¯c.
        
        QUY Táº®C VÃ€NG (TUYá»†T Äá»I PHáº¢I TUÃ‚N THá»¦):
        1. CHá»ˆ tÆ° váº¥n sáº£n pháº©m CÃ“ TRONG CONTEXT Ä‘Æ°á»£c cung cáº¥p (tá»« database).
        2. TUYá»†T Äá»I KHÃ”NG tá»± nghÄ© ra, táº¡o ra, hoáº·c thay Ä‘á»•i báº¥t ká»³ tÃªn sáº£n pháº©m nÃ o.
        3. TUYá»†T Äá»I KHÃ”NG gá»£i Ã½ sáº£n pháº©m KHÃ”NG CÃ“ trong context/database.
        4. Náº¿u khÃ´ng cÃ³ thÃ´ng tin trong context â†’ NÃ³i "Xin lá»—i, hiá»‡n táº¡i chÆ°a cÃ³ sáº£n pháº©m phÃ¹ há»£p. Báº¡n cÃ³ thá»ƒ liÃªn há»‡ CSKH Ä‘á»ƒ Ä‘Æ°á»£c tÆ° váº¥n thÃªm áº¡."
        
        TÆ¯ Váº¤N Sáº¢N PHáº¨M (CHá»ˆ DÃ™NG THÃ”NG TIN Tá»ª CONTEXT):
        A. Khi khÃ¡ch há»i CHUNG (vÃ­ dá»¥: "cÃ³ son gÃ¬", "cÃ³ kem gÃ¬"):
           - Náº¿u cÃ³ danh má»¥c con: liá»‡t kÃª danh má»¥c con Ä‘á»ƒ khÃ¡ch chá»n
           - Format: "ChÃ o báº¡n! Nova Beauty cÃ³ cÃ¡c loáº¡i [danh má»¥c] sau:\n1. [TÃªn danh má»¥c con 1]\n2. [TÃªn danh má»¥c con 2]\n\nBáº¡n muá»‘n xem chi tiáº¿t danh má»¥c nÃ o áº¡?"
        
        B. Khi khÃ¡ch há»i Cá»¤ THá»‚ (vÃ­ dá»¥: "son dior", "kem chá»‘ng náº¯ng la roche"):
           - CHá»ˆ giá»›i thiá»‡u ngáº¯n gá»n loáº¡i sáº£n pháº©m
           - KHÃ”NG liá»‡t kÃª tÃªn sáº£n pháº©m cá»¥ thá»ƒ trong text (há»‡ thá»‘ng sáº½ tá»± hiá»ƒn thá»‹ card)
           - Náº¿u >20 sáº£n pháº©m: Ä‘á» xuáº¥t lá»c theo thÆ°Æ¡ng hiá»‡u, giÃ¡, loáº¡i da
           - Format: "ChÃ o báº¡n! Nova Beauty cÃ³ cÃ¡c sáº£n pháº©m [loáº¡i] nhÆ° báº¡n Ä‘ang tÃ¬m kiáº¿m. DÆ°á»›i Ä‘Ã¢y lÃ  cÃ¡c sáº£n pháº©m báº¡n cÃ³ thá»ƒ tham kháº£o áº¡:"
        
        C. Khi khÃ¡ch CHá»ŒN sáº£n pháº©m:
           - ÄÆ°a link [LINK:/product/{id}] vá»›i ID CÃ“ TRONG CONTEXT
           - Format: "Báº¡n cÃ³ thá»ƒ xem chi tiáº¿t sáº£n pháº©m [tÃªn] táº¡i: [LINK:/product/{id}]"
        
        D. Khi khÃ¡ch Há»I Vá»€ THÆ¯Æ NG HIá»†U (vÃ­ dá»¥: "cÃ³ son dior"):
           - Náº¿u <10 sáº£n pháº©m: liá»‡t kÃª tÃªn vÃ  link tá»«ng sáº£n pháº©m
           - Náº¿u >=10 sáº£n pháº©m: Ä‘Æ°a link trang thÆ°Æ¡ng hiá»‡u [LINK:/products?brand={brand}]
        
        THÃ”NG TIN KHUYáº¾N MÃƒI/VOUCHER:
        - KHÃ”NG liá»‡t kÃª danh sÃ¡ch khuyáº¿n mÃ£i
        - HÆ°á»›ng dáº«n vÃ o trang Khuyáº¿n mÃ£i: [LINK:/promo]
        
        GIá»šI Háº N:
        - KHÃ”NG thá»ƒ tra cá»©u Ä‘Æ¡n hÃ ng cá»¥ thá»ƒ (cáº§n Ä‘Äƒng nháº­p)
        - KHÃ”NG thá»ƒ xá»­ lÃ½ khiáº¿u náº¡i/Ä‘á»•i tráº£ (cáº§n liÃªn há»‡ CSKH)
        - KHÃ”NG cÃ³ thÃ´ng tin tÃ i khoáº£n (cáº§n Ä‘Äƒng nháº­p)
        - KHÃ”NG thá»ƒ thanh toÃ¡n trá»±c tiáº¿p (cáº§n Ä‘áº·t hÃ ng trÃªn website)
        
        NGUYÃŠN Táº®C TRáº¢ Lá»œI:
        1. Ngáº¯n gá»n, rÃµ rÃ ng, dá»… hiá»ƒu
        2. NgÃ´n ngá»¯ thÃ¢n thiá»‡n, chuyÃªn nghiá»‡p
        3. CHá»ˆ tÆ° váº¥n sáº£n pháº©m CÃ“ TRONG CONTEXT
        4. Khi khÃ´ng cÃ³ thÃ´ng tin: thÃ nh tháº­t nÃ³i khÃ´ng cÃ³
        
        QUY Táº®C FORMATTING:
        1. TUYá»†T Äá»I KHÃ”NG dÃ¹ng markdown: **, ***, *, #, __, ~~
        2. Chá»‰ dÃ¹ng text thuáº§n tÃºy
        3. Liá»‡t kÃª: dÃ¹ng sá»‘ thá»© tá»± (1., 2., 3.) hoáº·c dáº¥u gáº¡ch (-)
        4. TrÃ­ch dáº«n: dÃ¹ng dáº¥u ngoáº·c kÃ©p ""
        """;
    
    public ChatResponse ask(ChatRequest request) {
        try {
            // 1. Validate request
            if (request == null || request.getMessage() == null || request.getMessage().isBlank()) {
                throw new AppException(ErrorCode.INVALID_REQUEST);
            }
            
            // 2. Táº¡o hoáº·c láº¥y sessionId
            String sessionId = request.getSessionId();
            if (sessionId == null || sessionId.isBlank()) {
                sessionId = UUID.randomUUID().toString();
            }
            
            // 3. Láº¥y conversation history
            List<GeminiContent> history = conversationHistory.getOrDefault(sessionId, new ArrayList<>());
            
            // 4. Build request cho Gemini
            GeminiRequest geminiRequest = buildGeminiRequest(request.getMessage(), history);
            
            // 5. Gá»i Gemini API vá»›i retry
            GeminiResponse response = callGeminiWithRetry(geminiRequest, 3);
            
            // 6. Extract reply
            String reply = response.getCandidates().get(0).getContent().getParts().get(0).getText();
            
            // 7. Remove markdown formatting
            reply = reply.replace("***", "").replace("**", "").replace("*", "");
            
            // 8. LÆ°u vÃ o history
            history.add(new GeminiContent("user", request.getMessage()));
            history.add(new GeminiContent("model", reply));
            conversationHistory.put(sessionId, history);
            
            // 9. Giá»›i háº¡n history (giá»¯ 10 cáº·p Q&A gáº§n nháº¥t)
            if (history.size() > 20) {
                history.subList(0, history.size() - 20).clear();
            }
            
            return ChatResponse.builder()
                    .reply(reply)
                    .sessionId(sessionId)
                    .build();
                    
        } catch (Exception e) {
            log.error("Error in chatbot service", e);
            throw new AppException(ErrorCode.UNCATEGORIZED_EXCEPTION);
        }
    }
    
    private GeminiRequest buildGeminiRequest(String userMessage, List<GeminiContent> history) {
        List<GeminiContent> contents = new ArrayList<>();
        
        // Refresh products context náº¿u cáº§n
        refreshProductsContextIfNeeded();
        
        // Táº¡o system prompt
        String systemPrompt = SYSTEM_PROMPT_BASE;
        
        // Chá»‰ thÃªm products context náº¿u cÃ¢u há»i liÃªn quan Ä‘áº¿n sáº£n pháº©m
        if (!isGreetingMessage(userMessage) && isProductRelatedQuestion(userMessage)) {
            String productsContext = getProductsContextForMessage(userMessage);
            if (!productsContext.isEmpty()) {
                systemPrompt += "\n\n" + productsContext;
            }
        }
        
        // Build contents
        if (history.isEmpty()) {
            // Conversation má»›i: thÃªm system prompt
            contents.add(new GeminiContent("user", systemPrompt + "\n\nCÃ¢u há»i cá»§a khÃ¡ch hÃ ng: " + userMessage));
        } else {
            // Conversation cÃ³ history: thÃªm history + message má»›i
            contents.addAll(history);
            
            String messageWithContext = userMessage;
            if (!isGreetingMessage(userMessage) && isProductRelatedQuestion(userMessage)) {
                String productsContext = getProductsContextForMessage(userMessage);
                if (!productsContext.isEmpty()) {
                    messageWithContext = "ThÃ´ng tin sáº£n pháº©m hiá»‡n cÃ³:\n" + productsContext 
                        + "\n\nCÃ¢u há»i cá»§a khÃ¡ch hÃ ng: " + userMessage;
                }
            }
            contents.add(new GeminiContent("user", messageWithContext));
        }
        
        GeminiRequest request = new GeminiRequest();
        request.setContents(contents);
        return request;
    }
    
    private GeminiResponse callGeminiWithRetry(GeminiRequest request, int maxRetries) {
        int retryCount = 0;
        long baseDelay = 2000; // 2 seconds
        
        while (retryCount < maxRetries) {
            try {
                return webClient.post()
                        .uri("/models/" + model + ":generateContent?key=" + apiKey)
                        .contentType(MediaType.APPLICATION_JSON)
                        .bodyValue(request)
                        .retrieve()
                        .bodyToMono(GeminiResponse.class)
                        .block();
                        
            } catch (WebClientResponseException e) {
                int statusCode = e.getStatusCode().value();
                String errorBody = e.getResponseBodyAsString();
                
                // 400 BadRequest: khÃ´ng retry
                if (statusCode == 400) {
                    log.error("Gemini API BadRequest (400): {}", errorBody);
                    throw new AppException(ErrorCode.UNCATEGORIZED_EXCEPTION);
                }
                
                // 404 NotFound: khÃ´ng retry
                if (statusCode == 404) {
                    log.error("Gemini API NotFound (404). Model '{}' not found", model);
                    throw new AppException(ErrorCode.UNCATEGORIZED_EXCEPTION);
                }
                
                // 429 TooManyRequests: retry vá»›i backoff
                if (statusCode == 429) {
                    // Náº¿u limit = 0, khÃ´ng retry
                    if (errorBody.contains("\"limit\": 0")) {
                        log.error("Gemini API quota exceeded (limit = 0)");
                        throw new AppException(ErrorCode.UNCATEGORIZED_EXCEPTION);
                    }
                    
                    if (retryCount < maxRetries) {
                        long delay = baseDelay * (long) Math.pow(2, retryCount);
                        log.warn("Gemini API rate limited. Retrying in {}ms (attempt {}/{})", 
                            delay, retryCount + 1, maxRetries);
                        Thread.sleep(delay);
                        retryCount++;
                        continue;
                    }
                }
                
                throw new AppException(ErrorCode.UNCATEGORIZED_EXCEPTION);
            } catch (Exception e) {
                log.error("Unexpected error calling Gemini API", e);
                throw new AppException(ErrorCode.UNCATEGORIZED_EXCEPTION);
            }
        }
        
        throw new AppException(ErrorCode.UNCATEGORIZED_EXCEPTION);
    }
    
    private void refreshProductsContextIfNeeded() {
        long now = System.currentTimeMillis();
        if (now - lastProductsCacheUpdate > PRODUCTS_CACHE_TTL || cachedProductsContext.isEmpty()) {
            refreshProductsContext();
        }
    }
    
    private void refreshProductsContext() {
        try {
            // Láº¥y sáº£n pháº©m tá»« database
            List<ProductResponse> products = productService.getActiveProducts();
            
            // Giá»›i háº¡n 100 sáº£n pháº©m Ä‘á»ƒ trÃ¡nh prompt quÃ¡ dÃ i
            int maxProducts = Math.min(100, products.size());
            
            // Format thÃ nh text context
            StringBuilder context = new StringBuilder();
            context.append("DANH SÃCH Sáº¢N PHáº¨M Cá»¦A NOVA BEAUTY:\n\n");
            
            for (int i = 0; i < maxProducts; i++) {
                ProductResponse product = products.get(i);
                context.append(String.format("%d. ID: %s | TÃªn: %s", 
                    i + 1, product.getId(), product.getName()));
                
                if (product.getBrand() != null) {
                    context.append(" | ThÆ°Æ¡ng hiá»‡u: ").append(product.getBrand());
                }
                
                if (product.getPrice() != null) {
                    context.append(String.format(" | GiÃ¡: %,.0f VNÄ", product.getPrice()));
                }
                
                if (product.getSkinType() != null) {
                    context.append(" | Loáº¡i da: ").append(product.getSkinType());
                }
                
                context.append("\n");
            }
            
            cachedProductsContext = context.toString();
            lastProductsCacheUpdate = System.currentTimeMillis();
            
            log.info("Products context refreshed: {} products", maxProducts);
            
        } catch (Exception e) {
            log.error("Error refreshing products context", e);
        }
    }
    
    private boolean isGreetingMessage(String message) {
        String lowerMessage = message.toLowerCase().trim();
        String[] greetingKeywords = {
            "hi", "hello", "xin chÃ o", "chÃ o", "chÃ o báº¡n",
            "hey", "háº¿ lÃ´", "alo"
        };
        for (String keyword : greetingKeywords) {
            if (lowerMessage.equals(keyword) || lowerMessage.startsWith(keyword + " ")) {
                return true;
            }
        }
        return false;
    }
    
    private boolean isProductRelatedQuestion(String message) {
        String lowerMessage = message.toLowerCase();
        String[] productKeywords = {
            "sáº£n pháº©m", "má»¹ pháº©m", "kem", "son", "nÆ°á»›c hoa",
            "trang Ä‘iá»ƒm", "chÄƒm sÃ³c", "tÆ° váº¥n", "giÃ¡", "mua", "bÃ¡n",
            "skincare", "makeup", "perfume"
        };
        for (String keyword : productKeywords) {
            if (lowerMessage.contains(keyword)) {
                return true;
            }
        }
        return false;
    }
    
    // ... ThÃªm cÃ¡c methods khÃ¡c nhÆ° getProductsContextForMessage(), 
    // getSubCategoriesContext(), getBrandProductsContext(), etc.
}
```

---

### PHáº¦N 2: FRONTEND (REACTJS)

#### 2.1. Chatbot Service (API Client)

```javascript
import axios from 'axios';

const API_BASE_URL = 'http://localhost:8080'; // Hoáº·c URL backend cá»§a báº¡n

const chatbotService = {
    /**
     * Gá»­i message Ä‘áº¿n chatbot AI
     * @param {string} message - Ná»™i dung tin nháº¯n
     * @param {string} sessionId - Session ID (optional)
     * @returns {Promise<{reply: string, sessionId: string}>}
     */
    async ask(message, sessionId = null) {
        try {
            const payload = { message };
            if (sessionId) {
                payload.sessionId = sessionId;
            }
            
            const response = await axios.post(`${API_BASE_URL}/api/chatbot/ask`, payload);
            
            return response.data.result;
        } catch (error) {
            console.error('[Chatbot Service] ask error:', error);
            throw error;
        }
    }
};

export default chatbotService;
```

#### 2.2. Chatbot Component (UI)

```jsx
import React, { useState, useEffect, useRef } from 'react';
import chatbotService from '~/services/chatbot';
import './Chatbot.scss';

const Chatbot = () => {
    const [isOpen, setIsOpen] = useState(false);
    const [messages, setMessages] = useState([]);
    const [inputMessage, setInputMessage] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [sessionId, setSessionId] = useState(null);
    const messagesEndRef = useRef(null);

    // Auto scroll to bottom
    const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    };

    useEffect(() => {
        scrollToBottom();
    }, [messages]);

    // Add greeting message when open
    useEffect(() => {
        if (isOpen && messages.length === 0) {
            setMessages([
                {
                    type: 'bot',
                    content: 'Xin chÃ o! TÃ´i lÃ  trá»£ lÃ½ AI cá»§a Nova Beauty. TÃ´i cÃ³ thá»ƒ giÃºp gÃ¬ cho báº¡n hÃ´m nay?',
                    timestamp: new Date()
                }
            ]);
        }
    }, [isOpen]);

    const handleSendMessage = async () => {
        if (!inputMessage.trim()) return;

        // Add user message
        const userMessage = {
            type: 'user',
            content: inputMessage,
            timestamp: new Date()
        };
        setMessages(prev => [...prev, userMessage]);
        setInputMessage('');
        setIsLoading(true);

        try {
            // Call API
            const response = await chatbotService.ask(inputMessage, sessionId);
            
            // Update sessionId
            if (response.sessionId) {
                setSessionId(response.sessionId);
            }

            // Add bot message
            const botMessage = {
                type: 'bot',
                content: response.reply,
                timestamp: new Date()
            };
            setMessages(prev => [...prev, botMessage]);
            
        } catch (error) {
            console.error('Error sending message:', error);
            const errorMessage = {
                type: 'bot',
                content: 'Xin lá»—i, Ä‘Ã£ cÃ³ lá»—i xáº£y ra. Vui lÃ²ng thá»­ láº¡i sau.',
                timestamp: new Date()
            };
            setMessages(prev => [...prev, errorMessage]);
        } finally {
            setIsLoading(false);
        }
    };

    const handleKeyPress = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSendMessage();
        }
    };

    return (
        <>
            {/* Chat button */}
            <button 
                className={`chatbot-button ${isOpen ? 'active' : ''}`}
                onClick={() => setIsOpen(!isOpen)}
            >
                <i className="fas fa-comments"></i>
            </button>

            {/* Chat window */}
            {isOpen && (
                <div className="chatbot-window">
                    {/* Header */}
                    <div className="chatbot-header">
                        <h3>Trá»£ lÃ½ AI Nova Beauty</h3>
                        <button onClick={() => setIsOpen(false)}>
                            <i className="fas fa-times"></i>
                        </button>
                    </div>

                    {/* Messages */}
                    <div className="chatbot-messages">
                        {messages.map((msg, index) => (
                            <div 
                                key={index} 
                                className={`message ${msg.type}`}
                            >
                                <div className="message-content">
                                    {msg.content}
                                </div>
                                <div className="message-time">
                                    {msg.timestamp.toLocaleTimeString('vi-VN', { 
                                        hour: '2-digit', 
                                        minute: '2-digit' 
                                    })}
                                </div>
                            </div>
                        ))}
                        {isLoading && (
                            <div className="message bot">
                                <div className="message-content loading">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </div>

                    {/* Input */}
                    <div className="chatbot-input">
                        <textarea
                            value={inputMessage}
                            onChange={(e) => setInputMessage(e.target.value)}
                            onKeyPress={handleKeyPress}
                            placeholder="Nháº­p tin nháº¯n..."
                            rows={1}
                            disabled={isLoading}
                        />
                        <button 
                            onClick={handleSendMessage}
                            disabled={isLoading || !inputMessage.trim()}
                        >
                            <i className="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            )}
        </>
    );
};

export default Chatbot;
```

#### 2.3. Chatbot Styles (SCSS)

```scss
.chatbot-button {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    transition: all 0.3s ease;
    z-index: 1000;

    &:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    &.active {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
}

.chatbot-window {
    position: fixed;
    bottom: 100px;
    right: 30px;
    width: 380px;
    height: 600px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    display: flex;
    flex-direction: column;
    z-index: 1000;
    overflow: hidden;

    .chatbot-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;

        h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        button {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
    }

    .chatbot-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #f5f5f5;

        .message {
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;

            &.user {
                align-items: flex-end;

                .message-content {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    max-width: 70%;
                    padding: 12px 16px;
                    border-radius: 18px 18px 4px 18px;
                }
            }

            &.bot {
                align-items: flex-start;

                .message-content {
                    background: white;
                    color: #333;
                    max-width: 70%;
                    padding: 12px 16px;
                    border-radius: 18px 18px 18px 4px;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);

                    &.loading {
                        display: flex;
                        gap: 4px;
                        padding: 16px;

                        span {
                            width: 8px;
                            height: 8px;
                            border-radius: 50%;
                            background: #667eea;
                            animation: bounce 1.4s infinite ease-in-out;

                            &:nth-child(1) {
                                animation-delay: -0.32s;
                            }
                            &:nth-child(2) {
                                animation-delay: -0.16s;
                            }
                        }
                    }
                }
            }

            .message-time {
                font-size: 11px;
                color: #999;
                margin-top: 4px;
            }
        }
    }

    .chatbot-input {
        padding: 16px;
        background: white;
        border-top: 1px solid #e0e0e0;
        display: flex;
        gap: 12px;

        textarea {
            flex: 1;
            border: 1px solid #e0e0e0;
            border-radius: 24px;
            padding: 12px 16px;
            font-size: 14px;
            resize: none;
            font-family: inherit;

            &:focus {
                outline: none;
                border-color: #667eea;
            }
        }

        button {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;

            &:hover:not(:disabled) {
                transform: scale(1.1);
            }

            &:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
        }
    }
}

@keyframes bounce {
    0%, 80%, 100% {
        transform: scale(0);
    }
    40% {
        transform: scale(1);
    }
}
```

---

### PHáº¦N 3: Cáº¤U HÃŒNH VÃ€ DEPLOYMENT

#### 3.1. Environment Variables

**Backend (application.yaml):**

```yaml
gemini:
  apiKey: ${GEMINI_API_KEY:your-api-key-here}
  model: gemini-1.5-flash # Hoáº·c gemini-2.0-flash, gemini-pro

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/nova_beauty
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD:password}
```

**Frontend (.env):**

```
REACT_APP_API_BASE_URL=http://localhost:8080
```

#### 3.2. Láº¥y Gemini API Key

1. Truy cáº­p [Google AI Studio](https://makersuite.google.com/app/apikey)
2. ÄÄƒng nháº­p báº±ng tÃ i khoáº£n Google
3. Click "Create API Key"
4. Copy API key vÃ  lÆ°u vÃ o environment variable

#### 3.3. Testing

**Test API báº±ng Postman/cURL:**

```bash
curl -X POST http://localhost:8080/api/chatbot/ask \
  -H "Content-Type: application/json" \
  -d '{
    "message": "Báº¡n cÃ³ sáº£n pháº©m nÃ o cho da dáº§u khÃ´ng?",
    "sessionId": null
  }'
```

**Expected Response:**

```json
{
  "code": 1000,
  "result": {
    "reply": "ChÃ o báº¡n! Nova Beauty cÃ³ cÃ¡c sáº£n pháº©m chÄƒm sÃ³c da cho da dáº§u. DÆ°á»›i Ä‘Ã¢y lÃ  cÃ¡c sáº£n pháº©m báº¡n cÃ³ thá»ƒ tham kháº£o áº¡:",
    "sessionId": "123e4567-e89b-12d3-a456-426614174000"
  }
}
```

---

## ğŸ¯ TÃNH NÄ‚NG NÃ‚NG CAO

### 1. Smart Context Loading

**Váº¥n Ä‘á»:** Prompt quÃ¡ dÃ i náº¿u load táº¥t cáº£ sáº£n pháº©m

**Giáº£i phÃ¡p:**

- Chá»‰ load context khi cÃ¢u há»i liÃªn quan Ä‘áº¿n sáº£n pháº©m
- Filter sáº£n pháº©m theo keyword
- Æ¯u tiÃªn danh má»¥c con khi há»i chung
- Giá»›i háº¡n 50-100 sáº£n pháº©m trong context

**Implementation:**

```java
private String getProductsContextForMessage(String userMessage) {
    // Extract keywords
    String[] productKeywords = extractProductKeywords(userMessage);
    
    if (productKeywords.length == 0) {
        return "";
    }
    
    // Kiá»ƒm tra cÃ¢u há»i chung hay cá»¥ thá»ƒ
    boolean isSpecific = isSpecificProductQuestion(userMessage);
    
    if (!isSpecific) {
        // CÃ¢u há»i chung: tráº£ vá» danh má»¥c con
        String subCategoriesContext = getSubCategoriesContext(productKeywords[0]);
        if (!subCategoriesContext.isEmpty()) {
            return subCategoriesContext;
        }
    }
    
    // Kiá»ƒm tra cÃ¢u há»i vá» brand
    String brandName = extractBrandFromMessage(userMessage);
    if (brandName != null) {
        String brandProductsContext = getBrandProductsContext(brandName);
        if (!brandProductsContext.isEmpty()) {
            return brandProductsContext;
        }
    }
    
    // Tráº£ vá» sáº£n pháº©m filtered
    return getFilteredProductsContext(productKeywords);
}
```

### 2. Subcategories Context

**Má»¥c Ä‘Ã­ch:** Khi user há»i chung (vÃ­ dá»¥: "cÃ³ son gÃ¬"), tráº£ vá» danh má»¥c con Ä‘á»ƒ user chá»n

**Implementation:**

```java
private String getSubCategoriesContext(String keyword) {
    try {
        // TÃ¬m category theo keyword
        List<CategoryResponse> categories = categoryService.getAllCategories();
        CategoryResponse mainCategory = null;
        
        // TÃ¬m category phÃ¹ há»£p
        for (CategoryResponse cat : categories) {
            if (cat.getName().toLowerCase().contains(keyword.toLowerCase())) {
                mainCategory = cat;
                break;
            }
        }
        
        if (mainCategory == null) {
            return "";
        }
        
        // Láº¥y subcategories
        List<CategoryResponse> subCategories = categoryService.getSubCategories(mainCategory.getId());
        
        if (subCategories.isEmpty()) {
            return "";
        }
        
        // Format context
        StringBuilder context = new StringBuilder();
        context.append("=== DANH Má»¤C CON Cá»¦A ").append(mainCategory.getName().toUpperCase()).append(" ===\n");
        context.append("TUYá»†T Äá»I CHá»ˆ LIá»†T KÃŠ ÄÃšNG Y Há»†T CÃC DANH Má»¤C CON SAU:\n\n");
        
        for (int i = 0; i < subCategories.size(); i++) {
            CategoryResponse subCat = subCategories.get(i);
            context.append(String.format("%d. %s", i + 1, subCat.getName()));
            if (subCat.getProductCount() != null && subCat.getProductCount() > 0) {
                context.append(String.format(" (%d sáº£n pháº©m)", subCat.getProductCount()));
            }
            context.append("\n");
        }
        
        return context.toString();
        
    } catch (Exception e) {
        log.error("Error getting subcategories", e);
        return "";
    }
}
```

### 3. Brand Products Context

**Má»¥c Ä‘Ã­ch:** Khi user há»i vá» thÆ°Æ¡ng hiá»‡u (vÃ­ dá»¥: "cÃ³ son dior"), tráº£ vá» sáº£n pháº©m cá»§a brand Ä‘Ã³

**Implementation:**

```java
private String getBrandProductsContext(String brandName) {
    try {
        // Search products by brand
        List<ProductResponse> brandProducts = productService.searchProducts(brandName)
            .stream()
            .filter(p -> p.getBrand() != null && p.getBrand().equalsIgnoreCase(brandName))
            .collect(Collectors.toList());
        
        if (brandProducts.isEmpty()) {
            return "";
        }
        
        // Format context
        StringBuilder context = new StringBuilder();
        context.append("=== Sáº¢N PHáº¨M THEO THÆ¯Æ NG HIá»†U: ").append(brandName.toUpperCase()).append(" ===\n");
        context.append("TÃŠN THÆ¯Æ NG HIá»†U: ").append(brandName).append("\n");
        context.append("Sá» LÆ¯á»¢NG Sáº¢N PHáº¨M: ").append(brandProducts.size()).append("\n\n");
        
        // Giá»›i háº¡n 50 sáº£n pháº©m
        int maxProducts = Math.min(50, brandProducts.size());
        for (int i = 0; i < maxProducts; i++) {
            ProductResponse product = brandProducts.get(i);
            context.append(String.format("%d. ID: %s | TÃªn: %s", 
                i + 1, product.getId(), product.getName()));
            if (product.getPrice() != null) {
                context.append(String.format(" | GiÃ¡: %,.0f VNÄ", product.getPrice()));
            }
            context.append("\n");
        }
        
        context.append("\nQUY Táº®C KHI TRáº¢ Lá»œI:\n");
        context.append("- Náº¿u cÃ³ <10 sáº£n pháº©m: liá»‡t kÃª táº¥t cáº£ tÃªn vÃ  link [LINK:/product/{id}]\n");
        context.append("- Náº¿u cÃ³ >=10 sáº£n pháº©m: Ä‘Æ°a link [LINK:/products?brand=" + brandName + "]\n");
        
        return context.toString();
        
    } catch (Exception e) {
        log.error("Error getting brand products", e);
        return "";
    }
}
```

### 4. Retry Logic With Exponential Backoff

**Má»¥c Ä‘Ã­ch:** Xá»­ lÃ½ quota exceeded vÃ  network errors

**Implementation Ä‘Ã£ Ä‘Æ°á»£c trÃ¬nh bÃ y á»Ÿ pháº§n ChatbotService.callGeminiWithRetry()**

### 5. Scheduled Cache Refresh

**Má»¥c Ä‘Ã­ch:** Tá»± Ä‘á»™ng refresh cache má»—i 30 phÃºt

**Implementation:**

```java
@Scheduled(fixedRate = PRODUCTS_CACHE_TTL)
public void scheduledRefreshProductsContext() {
    log.info("Scheduled task: Refreshing products context");
    refreshProductsContext();
}
```

**Configuration:**

```java
@Configuration
@EnableScheduling
public class SchedulingConfig {
    // Spring Boot sáº½ tá»± Ä‘á»™ng cháº¡y @Scheduled tasks
}
```

---

## ğŸ”’ Báº¢O Máº¬T VÃ€ Tá»I Æ¯U

### 1. Báº£o Máº­t API Key

```yaml
# KHÃ”NG commit API key vÃ o Git
gemini:
  apiKey: ${GEMINI_API_KEY}  # Láº¥y tá»« environment variable
```

```bash
# Set environment variable
export GEMINI_API_KEY="your-actual-api-key"
```

### 2. Rate Limiting

```java
@RateLimiter(name = "chatbot", fallbackMethod = "rateLimitFallback")
public ChatResponse ask(ChatRequest request) {
    // ...
}

public ChatResponse rateLimitFallback(ChatRequest request, Throwable t) {
    return ChatResponse.builder()
        .reply("Xin lá»—i, há»‡ thá»‘ng Ä‘ang quÃ¡ táº£i. Vui lÃ²ng thá»­ láº¡i sau.")
        .build();
}
```

### 3. Input Validation

```java
@Valid
public class ChatRequest {
    @NotBlank(message = "Message cannot be blank")
    @Size(max = 1000, message = "Message too long")
    private String message;
    
    private String sessionId;
}
```

### 4. Caching vá»›i Redis (Production)

```java
@Configuration
public class RedisConfig {
    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory factory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(factory);
        return template;
    }
}

// Usage
@Autowired
private RedisTemplate<String, Object> redisTemplate;

private void saveConversationHistory(String sessionId, List<GeminiContent> history) {
    redisTemplate.opsForValue().set("chat:" + sessionId, history, 30, TimeUnit.MINUTES);
}
```

---

## ğŸ“Š MONITORING VÃ€ LOGGING

### 1. Logging Strategy

```java
// Request logging
log.info("Chatbot request received: sessionId={}, message={}", 
    sessionId, request.getMessage().substring(0, Math.min(50, request.getMessage().length())));

// Response logging
log.info("Chatbot response sent: sessionId={}, reply_length={}", 
    sessionId, reply.length());

// Error logging
log.error("Error calling Gemini API: status={}, message={}, body={}", 
    statusCode, e.getMessage(), errorBody, e);
```

### 2. Metrics

```java
@Autowired
private MeterRegistry meterRegistry;

private void recordChatbotMetrics(boolean success) {
    Counter.builder("chatbot.requests")
        .tag("status", success ? "success" : "error")
        .register(meterRegistry)
        .increment();
}
```

---

## ğŸ§ª TESTING

### 1. Unit Tests

```java
@Test
public void testAsk_Success() {
    // Arrange
    ChatRequest request = ChatRequest.builder()
        .message("Báº¡n cÃ³ sáº£n pháº©m nÃ o cho da dáº§u khÃ´ng?")
        .build();
    
    // Act
    ChatResponse response = chatbotService.ask(request);
    
    // Assert
    assertNotNull(response);
    assertNotNull(response.getReply());
    assertNotNull(response.getSessionId());
}
```

### 2. Integration Tests

```java
@SpringBootTest
@AutoConfigureMockMvc
public class ChatbotControllerTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @Test
    public void testAskEndpoint() throws Exception {
        mockMvc.perform(post("/api/chatbot/ask")
                .contentType(MediaType.APPLICATION_JSON)
                .content("{\"message\":\"Xin chÃ o\"}"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.code").value(1000))
                .andExpect(jsonPath("$.result.reply").exists())
                .andExpect(jsonPath("$.result.sessionId").exists());
    }
}
```

---

## ğŸ“š TÃ€I LIá»†U THAM KHáº¢O

### Google Gemini API
- **Documentation**: https://ai.google.dev/docs
- **API Reference**: https://ai.google.dev/api/rest/v1/models/generateContent
- **Get API Key**: https://makersuite.google.com/app/apikey
- **Usage Limits**: https://ai.dev/usage?tab=rate-limit

### Alternative AI Services
- **OpenAI GPT**: https://platform.openai.com/docs/api-reference
- **Anthropic Claude**: https://docs.anthropic.com/claude/reference
- **Cohere**: https://docs.cohere.com/

---

## âœ… CHECKLIST IMPLEMENTATION

### Backend
- [ ] Táº¡o database vÃ  tables (products, categories)
- [ ] Implement ProductService.getActiveProducts()
- [ ] Implement CategoryService vá»›i subcategories
- [ ] Implement ChatbotService vá»›i cache mechanism
- [ ] Implement retry logic vá»›i exponential backoff
- [ ] Táº¡o ChatbotController vá»›i endpoint /api/chatbot/ask
- [ ] Setup Gemini API key trong application.yaml
- [ ] Test API vá»›i Postman/cURL
- [ ] Add logging vÃ  error handling
- [ ] (Optional) Setup Redis cho conversation history

### Frontend
- [ ] Táº¡o chatbot service (API client)
- [ ] Implement Chatbot component (UI)
- [ ] Add styling (SCSS/CSS)
- [ ] Handle loading state
- [ ] Handle errors gracefully
- [ ] Auto-scroll to bottom
- [ ] Save sessionId trong localStorage
- [ ] Test UI vá»›i cÃ¡c use cases

### Deployment
- [ ] Set environment variables (GEMINI_API_KEY, DB credentials)
- [ ] Build backend (mvn clean package)
- [ ] Build frontend (npm run build)
- [ ] Deploy backend (Heroku, AWS, etc.)
- [ ] Deploy frontend (Vercel, Netlify, etc.)
- [ ] Configure CORS
- [ ] Setup SSL/HTTPS
- [ ] Monitor logs vÃ  metrics

### Testing
- [ ] Test greeting messages
- [ ] Test product queries (chung vÃ  cá»¥ thá»ƒ)
- [ ] Test brand queries
- [ ] Test category queries
- [ ] Test conversation history
- [ ] Test error handling (invalid input, API errors)
- [ ] Test performance (response time)
- [ ] Test vá»›i nhiá»u users Ä‘á»“ng thá»i

---

## ğŸš€ NEXT STEPS & IMPROVEMENTS

### Short Term
1. Add product images trong response
2. Implement "Quick Replies" buttons
3. Add typing indicator animation
4. Save conversation history vÃ o database

### Medium Term
1. Multi-language support (English, Vietnamese)
2. Voice input/output
3. Product recommendations based on chat history
4. Integration vá»›i shopping cart

### Long Term
1. Custom AI model training
2. Sentiment analysis
3. Automated customer support tickets
4. Analytics dashboard
5. A/B testing different prompts

---

## ğŸ’¡ Máº¸O VÃ€ LÆ¯U Ã

### 1. System Prompt lÃ  Quan Trá»ng Nháº¥t

System prompt quyáº¿t Ä‘á»‹nh 80% cháº¥t lÆ°á»£ng chatbot. Cáº§n:
- RÃµ rÃ ng, chi tiáº¿t
- ÄÆ°a ra rules cá»¥ thá»ƒ
- CÃ³ vÃ­ dá»¥ format
- Nháº¥n máº¡nh "CHá»ˆ dÃ¹ng thÃ´ng tin tá»« context"

### 2. Context Loading Strategy

- KHÃ”NG load táº¥t cáº£ sáº£n pháº©m vÃ o má»i request
- Chá»‰ load context khi cáº§n
- Filter sáº£n pháº©m theo keyword
- Giá»›i háº¡n sá»‘ lÆ°á»£ng sáº£n pháº©m (50-100)

### 3. Conversation History

- Giá»›i háº¡n history (10-20 cáº·p Q&A)
- Clear history khi user refresh
- LÆ°u sessionId trong localStorage (frontend)
- DÃ¹ng Redis cho production

### 4. Error Handling

- Validate input trÆ°á»›c khi gá»i API
- Retry cho 429 (quota exceeded)
- KHÃ”NG retry cho 400, 404
- CÃ³ fallback message cho users

### 5. Performance

- Cache sáº£n pháº©m trong 30 phÃºt
- Scheduled task Ä‘á»ƒ refresh cache
- Optimize database queries (JOIN FETCH)
- DÃ¹ng connection pooling

### 6. Testing

- Test vá»›i real users
- Monitor response time
- Track error rates
- A/B test different prompts

---

**LÆ¯U Ã QUAN TRá»ŒNG:**

1. **API Key**: TUYá»†T Äá»I KHÃ”NG commit API key vÃ o Git
2. **Rate Limiting**: Gemini API cÃ³ giá»›i háº¡n requests per minute
3. **Cost**: Monitor usage Ä‘á»ƒ trÃ¡nh chi phÃ­ cao
4. **Privacy**: KHÃ”NG lÆ°u thÃ´ng tin nháº¡y cáº£m cá»§a users
5. **Fallback**: LuÃ´n cÃ³ plan B khi AI API down

---

**Káº¾T LUáº¬N:**

ÄÃ¢y lÃ  má»™t há»‡ thá»‘ng Chatbot AI hoÃ n chá»‰nh, production-ready vá»›i:
- âœ… Smart context loading
- âœ… Conversation history
- âœ… Error handling & retry logic
- âœ… Caching mechanism
- âœ… Frontend UI Ä‘áº¹p
- âœ… Scalable architecture

Báº¡n cÃ³ thá»ƒ customize vÃ  má»Ÿ rá»™ng dá»±a trÃªn nhu cáº§u cá»¥ thá»ƒ cá»§a dá»± Ã¡n!
